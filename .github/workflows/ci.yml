name: CI

# When to run this workflow
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  python-model-tests:
    runs-on: ubuntu-latest
    env:
      CACHIX_AUTH_TOKEN: ${{ secrets.CACHIX_AUTH_TOKEN }}
      ZAMLET_TEST_SCALE: "0.1"
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/nix-setup
      - name: Run Python model tests
        run: |
          nix-shell --run "cd python && python -m pytest zamlet/tests/ -v --tb=short -n auto"
      - name: Run kernel tests
        run: |
          nix-shell --run "cd python && python -m pytest zamlet/kernel_tests/ -v --tb=short -n auto"

  cocotb-tests:
    runs-on: ubuntu-latest
    env:
      CACHIX_AUTH_TOKEN: ${{ secrets.CACHIX_AUTH_TOKEN }}
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/nix-setup
      - name: Run cocotb tests
        run: |
          nix-shell --run "bazel test //python/zamlet:cocotb_tests --test_output=errors --keep_going"
      - name: Save Bazel cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: ~/.cache/bazel
          key: bazel-cocotb-${{ runner.os }}-${{ hashFiles('MODULE.bazel', 'MODULE.bazel.lock', 'shell.nix', 'nix/*.nix', 'nix/*.patch') }}

  synthesis:
    runs-on: ubuntu-latest
    env:
      CACHIX_AUTH_TOKEN: ${{ secrets.CACHIX_AUTH_TOKEN }}
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/nix-setup
      - name: WallaceMult8x8 flow
        run: |
          nix-shell --run "bazel build //dse/maths:WallaceMult8x8_sky130hd_mfg_report"
      - name: Upload failed step artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failed-WallaceMult8x8
          path: bazel-out/k8-fastbuild/bin/dse/maths/
          retention-days: 7
      - name: Save Bazel cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: ~/.cache/bazel
          key: bazel-synth-${{ runner.os }}-${{ hashFiles('MODULE.bazel', 'MODULE.bazel.lock', 'shell.nix', 'nix/*.nix', 'nix/*.patch') }}
