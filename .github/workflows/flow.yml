name: Physical Design Flow

on:
  workflow_dispatch:

jobs:
  flow:
    runs-on: ubuntu-latest
    env:
      CACHIX_AUTH_TOKEN: ${{ secrets.CACHIX_AUTH_TOKEN }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - package: dse/maths
            target: WallaceMult16x16_sky130hd_mfg_report
          - package: dse/jamlet
            target: NetworkNode_default_sky130hd_mfg_report
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/nix-setup
      - name: ${{ matrix.target }}
        run: |
          nix-shell --run "bazel build //${{ matrix.package }}:${{ matrix.target }}"
      - name: Upload failed step artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failed-${{ matrix.target }}
          path: bazel-out/k8-fastbuild/bin/${{ matrix.package }}/
          retention-days: 7
      - name: Save Bazel cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: ~/.cache/bazel
          key: bazel-flow-${{ matrix.target }}-${{ runner.os }}-${{ hashFiles('MODULE.bazel', 'MODULE.bazel.lock', 'shell.nix', 'nix/*.nix', 'nix/*.patch') }}
